<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/base :: layout(~{::title}, ~{::content})}">
<body>
<div th:fragment="content" class="container-fluid px-2">

    <div class="d-flex align-items-center mb-3">
        <div class="rounded-circle me-3 d-flex align-items-center justify-content-center" 
             style="width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
            <i class="bi bi-receipt-cutoff fs-5"></i>
        </div>
        <div>
            <h5 class="mb-1" th:text="${venta.id == null ? 'Nueva Venta' : 'Editar Venta'}">Formulario de Venta</h5>
            <small class="text-muted">Gestión de ventas a clientes</small>
        </div>
    </div>

    <div class="card">
        <div class="card-body p-3">
            <form th:action="@{/ventas}" th:object="${venta}" method="post">
                <input type="hidden" th:field="*{id}"/>

                <div class="row g-2 mb-3">
                    <div class="col-md-4">
                        <label class="form-label mb-1 small">Usuario</label>
                        <select th:field="*{usuarioId}" class="form-select form-select-sm" 
                                th:classappend="${#fields.hasErrors('usuarioId')} ? 'is-invalid' : ''">
                            <option value="">-- Seleccione Usuario --</option>
                            <option th:each="u : ${usuarios}"
                                    th:value="${u.id}"
                                    th:text="${u.nombre}">
                            </option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('usuarioId')}" th:errors="*{usuarioId}"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label mb-1 small">Cliente</label>
                        <select th:field="*{clienteId}" class="form-select form-select-sm" 
                                th:classappend="${#fields.hasErrors('clienteId')} ? 'is-invalid' : ''">
                            <option value="">-- Seleccione Cliente --</option>
                            <option th:each="c : ${clientes}"
                                    th:value="${c.id}"
                                    th:text="${c.empresa}">
                            </option>
                        </select>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('clienteId')}" th:errors="*{clienteId}"></div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label mb-1 small">Fecha</label>
                        <input type="date" th:field="*{fechaVenta}" class="form-control form-control-sm" 
                               th:classappend="${#fields.hasErrors('fechaVenta')} ? 'is-invalid' : ''"/>
                        <div class="invalid-feedback" th:if="${#fields.hasErrors('fechaVenta')}" th:errors="*{fechaVenta}"></div>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Detalles de la Venta</h6>
                    <button type="button" id="agregar-producto" class="btn btn-primary btn-sm">
                        <i class="bi bi-plus"></i> Agregar Producto
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-dark">
                        <tr>
                            <th>Producto</th>
                            <th style="width: 100px;">Cantidad</th>
                            <th style="width: 130px;">Precio Unitario</th>
                            <th style="width: 130px;">Subtotal</th>
                            <th style="width: 60px;">Acción</th>
                        </tr>
                        </thead>
                        <tbody id="detalles-body">
                        <tr th:each="detalle, iterStat : *{detalles}">
                            <td>
                                <select th:field="*{detalles[__${iterStat.index}__].productoId}"
                                        class="form-select form-select-sm producto-select">
                                    <option value="">-- Producto --</option>
                                    <option th:each="p : ${productos}"
                                            th:value="${p.id}"
                                            th:text="${p.nombre}"
                                            th:attr="data-precio=${p.precioUnitario}">
                                    </option>
                                </select>
                            </td>
                            <td>
                                <input type="number" min="1"
                                       th:field="*{detalles[__${iterStat.index}__].cantidad}"
                                       class="form-control form-control-sm cantidad-input"/>
                            </td>
                            <td>
                                <input type="text" pattern="[0-9]+(\.[0-9]+)?"
                                       th:field="*{detalles[__${iterStat.index}__].precioUnitario}"
                                       class="form-control form-control-sm precio-unitario editable-precio"
                                       placeholder="0.00"/>
                            </td>
                            <td>
                                <input type="number" step="0.01"
                                       th:field="*{detalles[__${iterStat.index}__].subtotal}"
                                       class="form-control form-control-sm subtotal"
                                       readonly/>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-danger btn-sm eliminar-fila">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="row mt-3">
                    <div class="col-md-4 ms-auto">
                        <label class="form-label mb-1 small fw-bold">Total de la Venta</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background: var(--primary-color); color: white;">$</span>
                            <input type="number" step="0.01" th:field="*{total}"
                                   class="form-control text-end fw-bold" readonly/>
                        </div>
                    </div>
                </div>

                <div class="d-flex gap-2 justify-content-end mt-3 pt-2 border-top">
                    <a th:href="@{/ventas}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-x-circle me-1"></i>Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="bi bi-check-circle me-1"></i>Guardar Venta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            function actualizarSubtotal(fila) {
                const precioInput = fila.querySelector('.precio-unitario');
                const cantidadInput = fila.querySelector('.cantidad-input');
                const subtotalInput = fila.querySelector('.subtotal');

                const precio = parseFloat(precioInput.value) || 0;
                const cantidad = parseInt(cantidadInput.value) || 0;

                subtotalInput.value = (precio * cantidad).toFixed(2);
            }

            function actualizarTotal() {
                let total = 0;
                document.querySelectorAll('#detalles-body tr').forEach(tr => {
                    total += parseFloat(tr.querySelector('.subtotal').value) || 0;
                });

                const totalInput = document.querySelector('input[name="total"]');
                if (totalInput) {
                    totalInput.value = total.toFixed(2);
                }
            }

            let contadorFilas = document.querySelectorAll('#detalles-body tr').length;

            function agregarFila() {
                const tbody = document.getElementById('detalles-body');
                const nuevaFila = document.createElement('tr');
                
                nuevaFila.innerHTML = `
                    <td>
                        <select name="detalles[${contadorFilas}].productoId" class="form-select form-select-sm producto-select">
                            <option value="">-- Producto --</option>
                            ${document.querySelector('.producto-select').innerHTML.replace('<option value="">-- Producto --</option>', '')}
                        </select>
                    </td>
                    <td>
                        <input type="number" min="1" name="detalles[${contadorFilas}].cantidad" class="form-control form-control-sm cantidad-input"/>
                    </td>
                    <td>
                        <input type="text" pattern="[0-9]+(\\.[0-9]+)?" name="detalles[${contadorFilas}].precioUnitario" class="form-control form-control-sm precio-unitario editable-precio" placeholder="0.00"/>
                    </td>
                    <td>
                        <input type="number" step="0.01" name="detalles[${contadorFilas}].subtotal" class="form-control form-control-sm subtotal" readonly/>
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger btn-sm eliminar-fila">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(nuevaFila);
                contadorFilas++;
                agregarEventosFila(nuevaFila);
            }

            function agregarEventosFila(fila) {
                const select = fila.querySelector('.producto-select');
                const cantidadInput = fila.querySelector('.cantidad-input');
                const precioInput = fila.querySelector('.editable-precio');
                const eliminarBtn = fila.querySelector('.eliminar-fila');

                select.addEventListener('change', e => {
                    const option = e.target.selectedOptions[0];
                    const precioBase = option ? (parseFloat(option.dataset.precio) || 0) : 0;
                    
                    precioInput.dataset.base = precioBase;
                    precioInput.value = precioBase;
                    
                    actualizarSubtotal(fila);
                    actualizarTotal();
                });

                cantidadInput.addEventListener('input', () => {
                    actualizarSubtotal(fila);
                    actualizarTotal();
                });

                precioInput.addEventListener('input', () => {
                    const base = parseFloat(precioInput.dataset.base) || 0;
                    let nuevo = parseFloat(precioInput.value) || 0;
                    
                    if (nuevo < base) {
                        precioInput.value = base.toFixed(2);
                    }
                    
                    actualizarSubtotal(fila);
                    actualizarTotal();
                });

                if (eliminarBtn) {
                    eliminarBtn.addEventListener('click', () => {
                        fila.remove();
                        actualizarTotal();
                    });
                }
            }

            // Agregar eventos a filas existentes
            document.querySelectorAll('#detalles-body tr').forEach(fila => {
                agregarEventosFila(fila);
                
                const select = fila.querySelector('.producto-select');
                const option = select.selectedOptions[0];
                const precioBase = option ? (parseFloat(option.dataset.precio) || 0) : 0;
                
                const precioInput = fila.querySelector('.precio-unitario');
                precioInput.dataset.base = precioBase;
                
                if (parseFloat(precioInput.value) < precioBase) {
                    precioInput.value = precioBase.toFixed(2);
                }
                
                actualizarSubtotal(fila);
            });

            // Botón agregar producto
            document.getElementById('agregar-producto').addEventListener('click', agregarFila);

            // Asegurar que haya al menos una fila vacía al cargar
            if (document.querySelectorAll('#detalles-body tr').length === 0) {
                agregarFila();
            }

            actualizarTotal();
        });
    </script>

</div>
</body>
</html>
