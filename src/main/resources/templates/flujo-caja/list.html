<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es"
      th:replace="~{layout/base :: layout(~{::title}, ~{::content})}">
<head>
    <title>Flujo de Caja - Modacol</title>
</head>
<body>
<div th:fragment="content" class="container-fluid px-2">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
            <i class="bi bi-cash-stack"></i> Flujo de Caja
        </h5>
    </div>

    <!-- MÉTRICAS PRINCIPALES -->
    <div class="row g-2 mb-3">
        <!-- Saldo Actual -->
        <div class="col-md-3 col-6">
            <div class="card dashboard-card-primary text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1 opacity-90">Saldo Actual</h6>
                            <h4 class="mb-0 fw-bold" 
                                th:classappend="${saldo != null && saldo > 0} ? '' : (${saldo != null && saldo < 0} ? 'text-warning' : '')">
                                $<span th:text="${saldo != null ? #numbers.formatDecimal(saldo, 0, 'COMMA', 0, 'POINT') : '0'}">0</span>
                            </h4>
                        </div>
                        <div class="dashboard-icon">
                            <i class="bi bi-wallet2 fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Ingresos -->
        <div class="col-md-3 col-6">
            <div class="card dashboard-card-success text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1 opacity-90">Total Ingresos</h6>
                            <h4 class="mb-0 fw-bold">
                                $<span th:text="${ingresos != null ? #numbers.formatDecimal(ingresos, 0, 'COMMA', 0, 'POINT') : '0'}">0</span>
                            </h4>
                            <small class="opacity-75" th:text="${conteoIngresos} + ' transacciones'">0 transacciones</small>
                        </div>
                        <div class="dashboard-icon">
                            <i class="bi bi-arrow-up-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Egresos -->
        <div class="col-md-3 col-6">
            <div class="card dashboard-card-warning text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1 opacity-90">Total Egresos</h6>
                            <h4 class="mb-0 fw-bold">
                                $<span th:text="${egresos != null ? #numbers.formatDecimal(egresos, 0, 'COMMA', 0, 'POINT') : '0'}">0</span>
                            </h4>
                            <small class="opacity-75" th:text="${conteoEgresos} + ' transacciones'">0 transacciones</small>
                        </div>
                        <div class="dashboard-icon">
                            <i class="bi bi-arrow-down-circle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Movimientos -->
        <div class="col-md-3 col-6">
            <div class="card dashboard-card-info text-white h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title mb-1 opacity-90">Movimientos</h6>
                            <h4 class="mb-0 fw-bold" th:text="${#lists.size(movimientos)}">0</h4>
                            <small class="opacity-75" th:if="${desde != null && hasta != null}">
                                <span th:text="${#temporals.format(desde, 'dd/MM')}">01/01</span> - 
                                <span th:text="${#temporals.format(hasta, 'dd/MM')}">31/01</span>
                            </small>
                        </div>
                        <div class="dashboard-icon">
                            <i class="bi bi-list-ul fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mensajes -->
    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-header" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white;">
            <h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filtros de Búsqueda</h6>
        </div>
        <div class="card-body py-2">
            <form th:action="@{/flujo-caja}" method="get">
                <div class="row g-2">
                    <div class="col-12 col-md-3">
                        <label class="form-label mb-0 small">Desde</label>
                        <input type="date"
                               class="form-control form-control-sm"
                               name="desde"
                               th:value="${desde}">
                    </div>
                    <div class="col-12 col-md-3">
                        <label class="form-label mb-0 small">Hasta</label>
                        <input type="date"
                               class="form-control form-control-sm"
                               name="hasta"
                               th:value="${hasta}">
                    </div>
                    <div class="col-12 col-md-3 d-flex align-items-end">
                        <div class="d-flex gap-1 w-100">
                            <button type="submit" class="btn btn-primary btn-sm flex-fill">
                                <i class="bi bi-search"></i>
                            </button>
                            <a th:href="@{/flujo-caja}" class="btn btn-secondary btn-sm flex-fill">
                                <i class="bi bi-x-circle"></i>
                            </a>
                            <a href="/reportes?tipo=flujo-caja" class="btn btn-success btn-sm flex-fill">
                                <i class="bi bi-file-earmark-excel"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Lista de movimientos -->
    <div class="card dashboard-table-card">
        <div class="card-header dashboard-header">
            <h6 class="mb-0 text-white"><i class="bi bi-clock-history me-2"></i>Movimientos de Caja</h6>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                <table class="table table-striped table-hover table-sm mb-0">
                    <thead class="table-dark">
                    <tr>
                        <th>Fecha</th>
                        <th>Tipo</th>
                        <th>Descripción</th>
                        <th class="text-end">Monto</th>
                        <th>Origen</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="mov : ${movimientos}">
                        <td>
                            <span th:text="${mov.fecha != null ? #temporals.format(mov.fecha, 'dd/MM/yyyy') : '-'}">
                                01/01/2024
                            </span>
                        </td>
                        <td>
                            <span th:text="${mov.tipoMovimiento}"
                                  th:classappend="${mov.tipoMovimiento != null and mov.tipoMovimiento.name() == 'INGRESO'} ?
                                      ' text-success fw-bold' :
                                      ' text-danger fw-bold'">
                                TIPO
                            </span>
                        </td>
                        <td th:text="${mov.descripcion}">Descripción</td>
                        <td class="text-end">
                            $
                            <span th:text="${mov.monto != null ? #numbers.formatDecimal(mov.monto, 0, 'COMMA', 0, 'POINT') : '0'}">
                                0
                            </span>
                        </td>
                        <td>
                            <small th:if="${mov.ventaId != null}">
                                Venta #<span th:text="${mov.ventaId}"></span>
                            </small>
                            <small th:if="${mov.compraId != null}">
                                Compra #<span th:text="${mov.compraId}"></span>
                            </small>
                            <small th:if="${mov.ventaId == null and mov.compraId == null}">
                                Manual
                            </small>
                        </td>
                    </tr>

                    <!-- Sin registros -->
                    <tr th:if="${#lists.isEmpty(movimientos)}">
                        <td colspan="6" class="text-center text-muted py-3">
                            <i class="bi bi-inbox fs-1 opacity-50 d-block"></i>
                            No hay movimientos registrados
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="card-footer py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        Total:
                        <span th:text="${#lists.size(movimientos)}">0</span> movimientos
                    </small>
                    <!-- Paginación placeholder -->
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled"><span class="page-link">Anterior</span></li>
                            <li class="page-item active"><span class="page-link">1</span></li>
                            <li class="page-item disabled"><span class="page-link">Siguiente</span></li>
                        </ul>
                    </nav>
                </div>
            </div>

        </div>
    </div>

</div>
</body>
</html>
